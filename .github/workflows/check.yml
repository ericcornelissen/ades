name: Check
on:
  pull_request: ~
  push:
    branches:
    - main

permissions: read-all

jobs:
  build:
    name: Build
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout repository
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        persist-credentials: false
    - name: Install Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version-file: go.mod
    - name: Verify action checksums
      uses: ./.github/actions/ghasum
    - name: Build binary
      run: go run tasks.go build
    - name: Build all release binaries
      run: go run tasks.go build-all
  container:
    name: Container
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        engine:
        - docker
        - podman
    needs:
    - build
    steps:
    - name: Checkout repository
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        persist-credentials: false
    - name: Install Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version-file: go.mod
    - name: Verify action checksums
      uses: ./.github/actions/ghasum
    - name: Build container with ${{ matrix.engine }}
      run: go run tasks.go container
      env:
        CONTAINER_ENGINE: ${{ matrix.engine }}
    - name: Test run container with ${{ matrix.engine }}
      run: ${CONTAINER_ENGINE} run --rm ericornelissen/ades -help
      env:
        CONTAINER_ENGINE: ${{ matrix.engine }}
  development-image:
    name: Development image
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout repository
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        persist-credentials: false
    - name: Install Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version-file: go.mod
    - name: Verify action checksums
      uses: ./.github/actions/ghasum
    - name: Build
      run: go run tasks.go dev-img
  format:
    name: Format
    runs-on: ubuntu-24.04
    needs:
    - build
    steps:
    - name: Checkout repository
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        persist-credentials: false
    - name: Install Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version-file: go.mod
    - name: Verify action checksums
      uses: ./.github/actions/ghasum
    - name: Check source code formatting
      run: go run tasks.go format-check
  gha-release:
    name: GitHub Actions Release Immutability
    runs-on: ubuntu-24.04
    if: ${{ github.event_name == 'pull_request' && startsWith(github.event.pull_request.head.ref || github.ref_name, 'renovate/') }}
    permissions:
      pull-requests: write # To comment on a Pull Request
    steps:
    - name: Parse
      id: parse
      shell: bash
      env:
        TITLE: ${{ github.event.pull_request.title }}
      run: |
        REPO=$(echo "${TITLE}" | awk -F' ' '{print $2}')
        OLD=$(echo "${TITLE}" | awk -F' ' '{print $4}')
        NEW=$(echo "${TITLE}" | awk -F' ' '{print $6}')

        {
          echo "repo=$REPO"
          echo "new=$NEW"
          echo "old=$OLD"
        } >>"$GITHUB_OUTPUT"
    - name: Check
      id: check
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
        NEW: ${{ steps.parse.outputs.new }}
        OLD: ${{ steps.parse.outputs.old }}
        REPO: ${{ steps.parse.outputs.repo }}
      run: |
        set -euo pipefail

        WAS_IMMUTABLE=$(gh release view "v${OLD}" --repo "${REPO}" --json isImmutable | jq .isImmutable)
        IS_IMMUTABLE=$(gh release view "v${NEW}" --repo "${REPO}" --json isImmutable | jq .isImmutable)

        echo "::debug::was ${WAS_IMMUTABLE}; is ${IS_IMMUTABLE}"
        {
        case "${WAS_IMMUTABLE};${IS_IMMUTABLE}" in
        'true;true')
          echo "comment="
          ;;
        'false;false')
          echo "comment=${OLD} was not an immutable release and ${NEW} still is not. :neutral_face:"
          ;;
        'true;false')
          echo "comment=${OLD} was an immutable release but ${NEW} is not. :cry:"
          ;;
        'false;true')
          echo "comment=${OLD} was not an immutable release but ${NEW} is! :smile:"
          ;;
        esac
        } >>"$GITHUB_OUTPUT"
    - name: Comment
      if: ${{ steps.check.outputs.comment != '' }}
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
        GH_URL: ${{ github.server_url }}
        COMMENT: ${{ steps.check.outputs.comment }}
        NUMBER: ${{ github.event.pull_request.number }}
        REPO: ${{ github.repository }}
      run: |
        URL="${GH_URL}/${REPO}/pull/${NUMBER}"
        gh pr comment "${URL}" --body "${COMMENT}"
  reproducible:
    name: Reproducible build
    runs-on: ubuntu-24.04
    needs:
    - build
    steps:
    - name: Checkout repository
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        persist-credentials: false
    - name: Install Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version-file: go.mod
    - name: Verify action checksums
      uses: ./.github/actions/ghasum
    - name: Check reproducibility
      run: go run tasks.go reproducible
  reproducible-container:
    name: Reproducible container
    runs-on: ubuntu-24.04
    needs:
    - container
    - reproducible
    steps:
    - name: Checkout repository
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        persist-credentials: false
    - name: Install Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version-file: go.mod
    - name: Verify action checksums
      uses: ./.github/actions/ghasum
    - name: Check reproducibility
      run: go run tasks.go reproducible-container
  reproducible-web:
    name: Reproducible web
    runs-on: ubuntu-24.04
    needs:
    - web
    steps:
    - name: Checkout repository
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        persist-credentials: false
    - name: Install Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version-file: go.mod
    - name: Verify action checksums
      uses: ./.github/actions/ghasum
    - name: Check reproducibility
      run: go run tasks.go web-reproducible
  test-unit:
    name: Unit test
    runs-on: ubuntu-24.04
    needs:
    - build
    steps:
    - name: Checkout repository
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        persist-credentials: false
    - name: Install Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version-file: go.mod
    - name: Verify action checksums
      uses: ./.github/actions/ghasum
    - name: Run tests
      run: go run tasks.go test-randomized
  test-dogfeed:
    name: Dogfeed
    runs-on: ubuntu-24.04
    needs:
    - test-unit
    steps:
    - name: Checkout repository
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        persist-credentials: false
    - name: Install Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version-file: go.mod
    - name: Verify action checksums
      uses: ./.github/actions/ghasum
    - name: Run on this repository
      run: go run tasks.go dogfeed
  test-mutation:
    name: Mutation test
    runs-on: ubuntu-24.04
    needs:
    - test-unit
    steps:
    - name: Checkout repository
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        persist-credentials: false
    - name: Install Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version-file: go.mod
    - name: Verify action checksums
      uses: ./.github/actions/ghasum
    - name: Run mutation tests
      run: go run tasks.go test-mutation
  test-web:
    name: Web test
    runs-on: ubuntu-24.04
    needs:
    - test-unit
    - web
    steps:
    - name: Checkout repository
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        persist-credentials: false
    - name: Install Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version-file: go.mod
    - name: Verify action checksums
      uses: ./.github/actions/ghasum
    - name: Run web tests
      run: go run tasks.go web-test
  vet:
    name: Vet
    runs-on: ubuntu-24.04
    needs:
    - build
    steps:
    - name: Checkout repository
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        persist-credentials: false
    - name: Install Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version-file: go.mod
    - name: Verify action checksums
      uses: ./.github/actions/ghasum
    - name: Vet source code
      run: go run tasks.go vet
  web:
    name: Web
    runs-on: ubuntu-24.04
    needs:
    - build
    steps:
    - name: Checkout repository
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        persist-credentials: false
    - name: Install Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version-file: go.mod
    - name: Verify action checksums
      uses: ./.github/actions/ghasum
    - name: Build web app
      run: go run tasks.go web-build
